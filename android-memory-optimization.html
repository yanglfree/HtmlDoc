<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Androidå†…å­˜ä¼˜åŒ–æŒ‡å— - å¿«é€ŸæŸ¥è¯¢æ‰‹å†Œ</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0d1117;
            --bg2: #161b22;
            --bg3: #21262d;
            --text: #e6edf3;
            --text2: #8b949e;
            --blue: #58a6ff;
            --green: #3fb950;
            --purple: #a371f7;
            --orange: #d29922;
            --cyan: #39c5cf;
            --red: #f85149;
            --border: #30363d
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        body {
            font-family: 'Inter', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.7
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 40px 24px
        }

        .hero {
            text-align: center;
            padding: 48px 24px;
            margin-bottom: 48px;
            background: linear-gradient(135deg, rgba(248, 81, 73, 0.15), rgba(210, 153, 34, 0.15));
            border-radius: 16px;
            border: 1px solid var(--border)
        }

        .hero h1 {
            font-size: 34px;
            margin-bottom: 12px;
            background: linear-gradient(135deg, var(--red), var(--orange));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent
        }

        .hero p {
            color: var(--text2);
            font-size: 16px
        }

        .section {
            margin-bottom: 48px
        }

        .section h2 {
            font-size: 22px;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--border);
            display: flex;
            align-items: center;
            gap: 10px
        }

        .section h2::before {
            content: '';
            width: 4px;
            height: 22px;
            background: linear-gradient(var(--red), var(--orange));
            border-radius: 2px
        }

        .section h3 {
            font-size: 18px;
            margin: 24px 0 16px;
            color: var(--orange)
        }

        p {
            margin-bottom: 16px;
            color: var(--text2)
        }

        code {
            font-family: 'JetBrains Mono', monospace;
            background: var(--bg3);
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 13px;
            color: var(--cyan)
        }

        pre {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            overflow-x: auto;
            font-size: 13px;
            line-height: 1.8;
            margin: 16px 0
        }

        pre code {
            background: none;
            padding: 0;
            color: var(--text)
        }

        .comment {
            color: var(--text2)
        }

        .keyword {
            color: var(--purple)
        }

        .string {
            color: var(--green)
        }

        .cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
            margin: 20px 0
        }

        .card {
            background: var(--bg2);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            transition: all .2s
        }

        .card:hover {
            border-color: var(--orange);
            transform: translateY(-2px)
        }

        .card h3 {
            font-size: 16px;
            color: var(--orange);
            margin-bottom: 12px
        }

        .card p,
        .card li {
            font-size: 14px;
            color: var(--text2);
            margin: 0
        }

        .card ul {
            margin: 8px 0 0 16px
        }

        .tip {
            background: rgba(210, 153, 34, 0.1);
            border: 1px solid rgba(210, 153, 34, 0.3);
            border-radius: 12px;
            padding: 16px 20px;
            margin: 20px 0
        }

        .tip.danger {
            background: rgba(248, 81, 73, 0.1);
            border-color: rgba(248, 81, 73, 0.3)
        }

        .tip.success {
            background: rgba(63, 185, 80, 0.1);
            border-color: rgba(63, 185, 80, 0.3)
        }

        .tip strong {
            display: block;
            margin-bottom: 6px;
            color: var(--orange)
        }

        .tip.danger strong {
            color: var(--red)
        }

        .tip.success strong {
            color: var(--green)
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            background: var(--bg2);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border);
            margin: 16px 0
        }

        th {
            background: var(--bg3);
            padding: 14px 16px;
            text-align: left;
            font-weight: 600
        }

        td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border)
        }

        tr:last-child td {
            border-bottom: none
        }

        .toc {
            position: fixed;
            top: 40px;
            right: 40px;
            width: 200px;
            background: var(--bg2);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px
        }

        .toc h3 {
            font-size: 12px;
            color: var(--text2);
            text-transform: uppercase;
            margin-bottom: 12px
        }

        .toc a {
            display: block;
            padding: 6px 0;
            color: var(--text2);
            text-decoration: none;
            font-size: 13px
        }

        .toc a:hover {
            color: var(--orange)
        }

        @media(max-width:1200px) {
            .toc {
                display: none
            }
        }

        @media(max-width:768px) {
            .container {
                padding: 24px 16px
            }

            .hero h1 {
                font-size: 26px
            }

            .cards {
                grid-template-columns: 1fr
            }
        }
    </style>
</head>

<body>
    <nav class="toc">
        <h3>ç›®å½•</h3><a href="#overview">å†…å­˜æ¦‚è¿°</a><a href="#leak">å†…å­˜æ³„æ¼</a><a href="#oom">OOMåˆ†æ</a><a
            href="#bitmap">Bitmapä¼˜åŒ–</a><a href="#object">å¯¹è±¡ä¼˜åŒ–</a><a href="#tools">æ£€æµ‹å·¥å…·</a><a href="#gc">GCä¼˜åŒ–</a><a
            href="#checklist">ä¼˜åŒ–æ¸…å•</a>
    </nav>

    <div class="container">
        <div class="hero">
            <h1>ğŸ’¾ Androidå†…å­˜ä¼˜åŒ–æŒ‡å—</h1>
            <p>Memory Optimization - æ‰“é€ æµç•…ç¨³å®šçš„åº”ç”¨</p>
        </div>

        <section id="overview" class="section">
            <h2>Android å†…å­˜æ¦‚è¿°</h2>
            <p>Androidä¸ºæ¯ä¸ªåº”ç”¨åˆ†é…æœ‰é™çš„å †å†…å­˜ï¼Œè¶…å‡ºé™åˆ¶ä¼šè§¦å‘OOMå´©æºƒã€‚åˆç†ç®¡ç†å†…å­˜æ˜¯Appç¨³å®šæ€§çš„å…³é”®ã€‚</p>

            <div class="cards">
                <div class="card">
                    <h3>ğŸ“Š å†…å­˜åŒºåŸŸ</h3>
                    <ul>
                        <li><strong>Java Heap</strong>: å¯¹è±¡å®ä¾‹</li>
                        <li><strong>Native Heap</strong>: Nativeä»£ç åˆ†é…</li>
                        <li><strong>Code</strong>: ä»£ç å’Œèµ„æº</li>
                        <li><strong>Stack</strong>: çº¿ç¨‹æ ˆ</li>
                        <li><strong>Graphics</strong>: å›¾å½¢ç¼“å†²</li>
                    </ul>
                </div>
                <div class="card">
                    <h3>ğŸ“ˆ å†…å­˜é™åˆ¶</h3>
                    <ul>
                        <li>æ™®é€šåº”ç”¨: 128-512MB</li>
                        <li>largeHeap: 256-1024MB</li>
                        <li>ç”±è®¾å¤‡å’ŒROMå†³å®š</li>
                        <li><code>Runtime.maxMemory()</code></li>
                    </ul>
                </div>
                <div class="card">
                    <h3>âš ï¸ å¸¸è§é—®é¢˜</h3>
                    <ul>
                        <li>å†…å­˜æ³„æ¼ (Memory Leak)</li>
                        <li>å†…å­˜æŠ–åŠ¨ (Memory Churn)</li>
                        <li>å¤§å¯¹è±¡åˆ†é…</li>
                        <li>Bitmapå ç”¨è¿‡é«˜</li>
                    </ul>
                </div>
            </div>

            <pre><code><span class="comment">// è·å–å†…å­˜ä¿¡æ¯</span>
<span class="keyword">val</span> runtime = Runtime.getRuntime()
<span class="keyword">val</span> maxMemory = runtime.maxMemory() / 1024 / 1024  <span class="comment">// æœ€å¤§å¯ç”¨MB</span>
<span class="keyword">val</span> totalMemory = runtime.totalMemory() / 1024 / 1024  <span class="comment">// å½“å‰å·²åˆ†é…</span>
<span class="keyword">val</span> freeMemory = runtime.freeMemory() / 1024 / 1024   <span class="comment">// å½“å‰ç©ºé—²</span>

<span class="comment">// è·å–æ›´è¯¦ç»†çš„å†…å­˜ä¿¡æ¯</span>
<span class="keyword">val</span> activityManager = getSystemService(ACTIVITY_SERVICE) <span class="keyword">as</span> ActivityManager
<span class="keyword">val</span> memoryInfo = ActivityManager.MemoryInfo()
activityManager.getMemoryInfo(memoryInfo)
<span class="comment">// memoryInfo.availMem, memoryInfo.totalMem, memoryInfo.lowMemory</span></code></pre>
        </section>

        <section id="leak" class="section">
            <h2>å†…å­˜æ³„æ¼ Memory Leak</h2>
            <p>å†…å­˜æ³„æ¼æ˜¯æŒ‡å¯¹è±¡ä¸å†ä½¿ç”¨ä½†æ— æ³•è¢«GCå›æ”¶ï¼ŒæŒç»­ç´¯ç§¯æœ€ç»ˆå¯¼è‡´OOMã€‚</p>

            <h3>å¸¸è§æ³„æ¼åœºæ™¯</h3>
            <table>
                <thead>
                    <tr>
                        <th>åœºæ™¯</th>
                        <th>åŸå› </th>
                        <th>è§£å†³æ–¹æ¡ˆ</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>é™æ€å˜é‡æŒæœ‰Activity</td>
                        <td>staticå¼•ç”¨é˜»æ­¢GC</td>
                        <td>ä½¿ç”¨WeakReferenceæˆ–åŠæ—¶ç½®ç©º</td>
                    </tr>
                    <tr>
                        <td>éé™æ€å†…éƒ¨ç±»</td>
                        <td>éšå¼æŒæœ‰å¤–éƒ¨ç±»å¼•ç”¨</td>
                        <td>æ”¹ä¸ºé™æ€å†…éƒ¨ç±»+WeakReference</td>
                    </tr>
                    <tr>
                        <td>Handleræ¶ˆæ¯æœªç§»é™¤</td>
                        <td>MessageQueueæŒæœ‰Handler</td>
                        <td>onDestroyä¸­removeCallbacksAndMessages</td>
                    </tr>
                    <tr>
                        <td>æœªæ³¨é”€ç›‘å¬å™¨</td>
                        <td>ç³»ç»ŸæŒæœ‰å›è°ƒå¼•ç”¨</td>
                        <td>åœ¨å¯¹åº”ç”Ÿå‘½å‘¨æœŸæ³¨é”€</td>
                    </tr>
                    <tr>
                        <td>å•ä¾‹æŒæœ‰Context</td>
                        <td>Application Contextä»¥å¤–çš„Context</td>
                        <td>ä½¿ç”¨ApplicationContext</td>
                    </tr>
                    <tr>
                        <td>èµ„æºæœªå…³é—­</td>
                        <td>Cursorã€Streamç­‰æœªclose</td>
                        <td>ä½¿ç”¨use{}æˆ–try-finallyå…³é—­</td>
                    </tr>
                    <tr>
                        <td>åŠ¨ç”»æœªå–æ¶ˆ</td>
                        <td>å±æ€§åŠ¨ç”»æŒæœ‰View</td>
                        <td>onDestroyä¸­cancelåŠ¨ç”»</td>
                    </tr>
                </tbody>
            </table>

            <h3>å…¸å‹æ³„æ¼ä»£ç  vs ä¿®å¤</h3>
            <pre><code><span class="comment">// âŒ é”™è¯¯ï¼šéé™æ€Handlerå¯¼è‡´æ³„æ¼</span>
<span class="keyword">class</span> MainActivity : AppCompatActivity() {
    <span class="keyword">private val</span> handler = <span class="keyword">object</span> : Handler(Looper.getMainLooper()) {
        <span class="keyword">override fun</span> handleMessage(msg: Message) {
            <span class="comment">// éšå¼æŒæœ‰MainActivityå¼•ç”¨</span>
        }
    }
}

<span class="comment">// âœ… æ­£ç¡®ï¼šé™æ€å†…éƒ¨ç±» + WeakReference</span>
<span class="keyword">class</span> MainActivity : AppCompatActivity() {
    <span class="keyword">private class</span> SafeHandler(activity: MainActivity) : Handler(Looper.getMainLooper()) {
        <span class="keyword">private val</span> weakActivity = WeakReference(activity)
        <span class="keyword">override fun</span> handleMessage(msg: Message) {
            weakActivity.get()?.handleMsg(msg)
        }
    }
    
    <span class="keyword">private val</span> handler = SafeHandler(<span class="keyword">this</span>)
    
    <span class="keyword">override fun</span> onDestroy() {
        handler.removeCallbacksAndMessages(<span class="keyword">null</span>)
        <span class="keyword">super</span>.onDestroy()
    }
}</code></pre>

            <div class="tip danger"><strong>ğŸš¨ æœ€å±é™©çš„æ³„æ¼</strong>
                <p style="margin-top:8px">Activity/Fragmentæ³„æ¼æœ€ä¸¥é‡ï¼Œå› ä¸ºå®ƒä»¬æŒæœ‰æ•´ä¸ªViewæ ‘å’Œå¤§é‡èµ„æºã€‚å•ä¸ªActivityæ³„æ¼å¯èƒ½å¯¼è‡´å‡ åMBå†…å­˜æ— æ³•å›æ”¶ã€‚</p>
            </div>
        </section>

        <section id="oom" class="section">
            <h2>OOM åˆ†æä¸é¢„é˜²</h2>
            <p>OutOfMemoryErrorè¡¨ç¤ºå †å†…å­˜ä¸è¶³ä»¥åˆ†é…æ–°å¯¹è±¡ï¼Œéœ€è¦åˆ†æå †è½¬å‚¨å®šä½é—®é¢˜ã€‚</p>

            <h3>OOM ç±»å‹</h3>
            <div class="cards">
                <div class="card">
                    <h3>ğŸ“¦ Java Heap OOM</h3>
                    <p>Javaå¯¹è±¡åˆ†é…è¶…å‡ºmaxMemoryé™åˆ¶<br><code>java.lang.OutOfMemoryError: Java heap space</code></p>
                </div>
                <div class="card">
                    <h3">ğŸ”¢ çº¿ç¨‹åˆ›å»ºOOM</h3>
                        <p>åˆ›å»ºè¿‡å¤šçº¿ç¨‹è€—å°½å†…å­˜/FD<br><code>pthread_create failed</code></p>
                </div>
                <div class="card">
                    <h3">ğŸ“ FDè€—å°½</h3>
                        <p>æ–‡ä»¶æè¿°ç¬¦è¶…é™<br><code>Too many open files</code></p>
                </div>
            </div>

            <h3>é¢„é˜²æªæ–½</h3>
            <pre><code><span class="comment">// 1. ç›‘å¬ä½å†…å­˜è­¦å‘Š</span>
<span class="keyword">class</span> MyApp : Application(), ComponentCallbacks2 {
    <span class="keyword">override fun</span> onTrimMemory(level: Int) {
        <span class="keyword">when</span> (level) {
            TRIM_MEMORY_RUNNING_LOW -> clearCaches()
            TRIM_MEMORY_UI_HIDDEN -> releaseUIResources()
            TRIM_MEMORY_COMPLETE -> releaseAllCaches()
        }
    }
}

<span class="comment">// 2. å›¾ç‰‡åŠ è½½è®¾ç½®å†…å­˜ç¼“å­˜ä¸Šé™</span>
Glide.with(context)
    .setMemoryCategory(MemoryCategory.LOW)

<span class="comment">// 3. å¤§å¯¹è±¡åˆ†é…å‰æ£€æŸ¥</span>
<span class="keyword">fun</span> canAllocate(bytes: Long): Boolean {
    <span class="keyword">val</span> runtime = Runtime.getRuntime()
    <span class="keyword">return</span> runtime.freeMemory() + 
           (runtime.maxMemory() - runtime.totalMemory()) > bytes
}</code></pre>
        </section>

        <section id="bitmap" class="section">
            <h2>Bitmap å†…å­˜ä¼˜åŒ–</h2>
            <p>Bitmapæ˜¯å†…å­˜å¤§æˆ·ï¼Œä¸€å¼ 1080x1920çš„ARGB_8888å›¾ç‰‡å ç”¨çº¦8MBå†…å­˜ã€‚</p>

            <h3>Bitmapå†…å­˜è®¡ç®—</h3>
            <pre><code><span class="comment">// å†…å­˜ = å®½ Ã— é«˜ Ã— æ¯åƒç´ å­—èŠ‚æ•°</span>
<span class="comment">// ARGB_8888: 4 bytes/pixel</span>
<span class="comment">// RGB_565:   2 bytes/pixel</span>
<span class="comment">// ALPHA_8:   1 byte/pixel</span>

1080 Ã— 1920 Ã— 4 = 8,294,400 bytes â‰ˆ <span class="string">8MB</span></code></pre>

            <h3>ä¼˜åŒ–ç­–ç•¥</h3>
            <table>
                <thead>
                    <tr>
                        <th>ç­–ç•¥</th>
                        <th>æ–¹æ³•</th>
                        <th>æ•ˆæœ</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>é™é‡‡æ ·</td>
                        <td>inSampleSize=2</td>
                        <td>å†…å­˜å‡å°‘75%</td>
                    </tr>
                    <tr>
                        <td>é¢œè‰²æ ¼å¼</td>
                        <td>RGB_565æ›¿ä»£ARGB_8888</td>
                        <td>å†…å­˜å‡å°‘50%</td>
                    </tr>
                    <tr>
                        <td>å¤ç”¨Bitmap</td>
                        <td>inBitmapå¤ç”¨å†…å­˜</td>
                        <td>å‡å°‘GC</td>
                    </tr>
                    <tr>
                        <td>æŒ‰éœ€åŠ è½½</td>
                        <td>åªåŠ è½½å¯è§åŒºåŸŸ</td>
                        <td>å¤§å›¾åˆ†å—</td>
                    </tr>
                    <tr>
                        <td>åŠæ—¶å›æ”¶</td>
                        <td>bitmap.recycle()</td>
                        <td>ä¸»åŠ¨é‡Šæ”¾</td>
                    </tr>
                </tbody>
            </table>

            <pre><code><span class="comment">// è®¡ç®—åˆé€‚çš„inSampleSize</span>
<span class="keyword">fun</span> calculateInSampleSize(options: BitmapFactory.Options, 
                           reqWidth: Int, reqHeight: Int): Int {
    <span class="keyword">val</span> height = options.outHeight
    <span class="keyword">val</span> width = options.outWidth
    <span class="keyword">var</span> inSampleSize = 1
    
    <span class="keyword">if</span> (height > reqHeight || width > reqWidth) {
        <span class="keyword">val</span> halfHeight = height / 2
        <span class="keyword">val</span> halfWidth = width / 2
        <span class="keyword">while</span> ((halfHeight / inSampleSize) >= reqHeight &&
               (halfWidth / inSampleSize) >= reqWidth) {
            inSampleSize *= 2
        }
    }
    <span class="keyword">return</span> inSampleSize
}

<span class="comment">// ä½¿ç”¨inSampleSizeåŠ è½½</span>
<span class="keyword">val</span> options = BitmapFactory.Options().apply {
    inJustDecodeBounds = <span class="keyword">true</span>  <span class="comment">// åªè¯»å°ºå¯¸</span>
}
BitmapFactory.decodeResource(res, resId, options)
options.inSampleSize = calculateInSampleSize(options, reqW, reqH)
options.inJustDecodeBounds = <span class="keyword">false</span>
<span class="keyword">val</span> bitmap = BitmapFactory.decodeResource(res, resId, options)</code></pre>

            <div class="tip success"><strong>âœ… ä½¿ç”¨å›¾ç‰‡åŠ è½½åº“</strong>
                <p style="margin-top:8px">Glide/Coil/Picassoç­‰åº“å·²å†…ç½®é‡‡æ ·ã€ç¼“å­˜ã€å¤ç”¨ç­‰ä¼˜åŒ–ï¼Œä¼˜å…ˆä½¿ç”¨æˆç†Ÿåº“è€Œéæ‰‹åŠ¨å¤„ç†ã€‚</p>
            </div>
        </section>

        <section id="object" class="section">
            <h2>å¯¹è±¡ä¸é›†åˆä¼˜åŒ–</h2>

            <h3>å‡å°‘å¯¹è±¡åˆ›å»º</h3>
            <div class="cards">
                <div class="card">
                    <h3">â™»ï¸ å¯¹è±¡æ± </h3>
                        <p>Message.obtain()ã€Pools.acquire()å¤ç”¨å¯¹è±¡ï¼Œé¿å…é¢‘ç¹åˆ›å»º</p>
                </div>
                <div class="card">
                    <h3">ğŸ“¦ åŸºæœ¬ç±»å‹ä¼˜å…ˆ</h3>
                        <p>ç”¨intæ›¿ä»£Integerï¼Œç”¨LongSparseArrayæ›¿ä»£HashMap&lt;Long,Object&gt;</p>
                </div>
                <div class="card">
                    <h3">âš¡ é¿å…è£…ç®±</h3>
                        <p>ä½¿ç”¨SparseArrayã€SparseBooleanArrayç­‰é¿å…è‡ªåŠ¨è£…ç®±</p>
                </div>
            </div>

            <h3>é›†åˆé€‰æ‹©</h3>
            <table>
                <thead>
                    <tr>
                        <th>åœºæ™¯</th>
                        <th>æ¨è</th>
                        <th>é¿å…</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>intâ†’Objectæ˜ å°„</td>
                        <td>SparseArray</td>
                        <td>HashMap&lt;Integer,Object&gt;</td>
                    </tr>
                    <tr>
                        <td>intâ†’intæ˜ å°„</td>
                        <td>SparseIntArray</td>
                        <td>HashMap&lt;Integer,Integer&gt;</td>
                    </tr>
                    <tr>
                        <td>longâ†’Objectæ˜ å°„</td>
                        <td>LongSparseArray</td>
                        <td>HashMap&lt;Long,Object&gt;</td>
                    </tr>
                    <tr>
                        <td>å°æ•°æ®é›†åˆ</td>
                        <td>ArrayMap</td>
                        <td>HashMap</td>
                    </tr>
                    <tr>
                        <td>å°æ•°æ®Set</td>
                        <td>ArraySet</td>
                        <td>HashSet</td>
                    </tr>
                </tbody>
            </table>

            <pre><code><span class="comment">// âŒ äº§ç”Ÿå¤§é‡ä¸´æ—¶å¯¹è±¡</span>
<span class="keyword">for</span> (i <span class="keyword">in</span> 0..1000) {
    <span class="keyword">val</span> point = Point(x, y)  <span class="comment">// æ¯æ¬¡å¾ªç¯æ–°å»ºå¯¹è±¡</span>
}

<span class="comment">// âœ… å¤ç”¨å¯¹è±¡</span>
<span class="keyword">val</span> point = Point()
<span class="keyword">for</span> (i <span class="keyword">in</span> 0..1000) {
    point.set(x, y)  <span class="comment">// å¤ç”¨åŒä¸€ä¸ªå¯¹è±¡</span>
}

<span class="comment">// âŒ å­—ç¬¦ä¸²æ‹¼æ¥åˆ›å»ºä¸´æ—¶å¯¹è±¡</span>
<span class="keyword">var</span> str = <span class="string">""</span>
<span class="keyword">for</span> (i <span class="keyword">in</span> 0..100) {
    str += i.toString()  <span class="comment">// æ¯æ¬¡åˆ›å»ºæ–°String</span>
}

<span class="comment">// âœ… ä½¿ç”¨StringBuilder</span>
<span class="keyword">val</span> sb = StringBuilder()
<span class="keyword">for</span> (i <span class="keyword">in</span> 0..100) {
    sb.append(i)
}</code></pre>
        </section>

        <section id="tools" class="section">
            <h2>å†…å­˜æ£€æµ‹å·¥å…·</h2>

            <table>
                <thead>
                    <tr>
                        <th>å·¥å…·</th>
                        <th>ç”¨é€”</th>
                        <th>ä½¿ç”¨åœºæ™¯</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Android Studio Profiler</strong></td>
                        <td>å®æ—¶å†…å­˜ç›‘æ§ã€å †è½¬å‚¨</td>
                        <td>å¼€å‘è°ƒè¯•</td>
                    </tr>
                    <tr>
                        <td><strong>LeakCanary</strong></td>
                        <td>è‡ªåŠ¨æ£€æµ‹å†…å­˜æ³„æ¼</td>
                        <td>å¼€å‘é˜¶æ®µå¿…å¤‡</td>
                    </tr>
                    <tr>
                        <td><strong>MAT (Memory Analyzer)</strong></td>
                        <td>åˆ†æhprofå †è½¬å‚¨</td>
                        <td>å®šä½ç–‘éš¾æ³„æ¼</td>
                    </tr>
                    <tr>
                        <td><strong>adb shell dumpsys meminfo</strong></td>
                        <td>å‘½ä»¤è¡ŒæŸ¥çœ‹å†…å­˜</td>
                        <td>å¿«é€Ÿæ£€æŸ¥</td>
                    </tr>
                    <tr>
                        <td><strong>Perfetto</strong></td>
                        <td>ç³»ç»Ÿçº§å†…å­˜è¿½è¸ª</td>
                        <td>æ·±åº¦åˆ†æ</td>
                    </tr>
                </tbody>
            </table>

            <h3>LeakCanary é›†æˆ</h3>
            <pre><code><span class="comment">// build.gradle</span>
dependencies {
    debugImplementation <span class="string">'com.squareup.leakcanary:leakcanary-android:2.12'</span>
}

<span class="comment">// æ— éœ€å…¶ä»–é…ç½®ï¼Œè‡ªåŠ¨æ£€æµ‹Activity/Fragmentæ³„æ¼</span>
<span class="comment">// æ³„æ¼æ—¶ä¼šå¼¹å‡ºé€šçŸ¥ï¼Œç‚¹å‡»æŸ¥çœ‹æ³„æ¼é“¾</span></code></pre>

            <h3>adb å‘½ä»¤</h3>
            <pre><code><span class="comment"># æŸ¥çœ‹åº”ç”¨å†…å­˜ä¿¡æ¯</span>
adb shell dumpsys meminfo com.example.app

<span class="comment"># è§¦å‘GC</span>
adb shell am force-gc com.example.app

<span class="comment"># è·å–å †è½¬å‚¨</span>
adb shell am dumpheap com.example.app /data/local/tmp/heap.hprof
adb pull /data/local/tmp/heap.hprof</code></pre>
        </section>

        <section id="gc" class="section">
            <h2>GC ä¼˜åŒ–</h2>
            <p>é¢‘ç¹GCï¼ˆå†…å­˜æŠ–åŠ¨ï¼‰ä¼šé€ æˆå¡é¡¿ï¼Œåº”å‡å°‘çŸ­ç”Ÿå‘½å‘¨æœŸå¯¹è±¡çš„åˆ›å»ºã€‚</p>

            <div class="cards">
                <div class="card">
                    <h3">ğŸ” è¯†åˆ«å†…å­˜æŠ–åŠ¨</h3>
                        <p>Profilerä¸­çœ‹åˆ°é”¯é½¿çŠ¶å†…å­˜æ›²çº¿ï¼Œä¼´éšé¢‘ç¹GCäº‹ä»¶</p>
                </div>
                <div class="card">
                    <h3">âŒ å…¸å‹åŸå› </h3>
                        <p>å¾ªç¯å†…åˆ›å»ºå¯¹è±¡ã€onDrawä¸­newå¯¹è±¡ã€å­—ç¬¦ä¸²æ‹¼æ¥</p>
                </div>
                <div class="card">
                    <h3">âœ… è§£å†³æ–¹æ¡ˆ</h3>
                        <p>å¯¹è±¡å¤ç”¨ã€å¯¹è±¡æ± ã€é¿å…åœ¨çƒ­ç‚¹è·¯å¾„åˆ†é…</p>
                </div>
            </div>

            <pre><code><span class="comment">// âŒ onDrawä¸­åˆ›å»ºå¯¹è±¡å¯¼è‡´å†…å­˜æŠ–åŠ¨</span>
<span class="keyword">override fun</span> onDraw(canvas: Canvas) {
    <span class="keyword">val</span> paint = Paint()  <span class="comment">// æ¯å¸§åˆ›å»ºæ–°Paintï¼</span>
    <span class="keyword">val</span> rect = Rect()    <span class="comment">// æ¯å¸§åˆ›å»ºæ–°Rectï¼</span>
    canvas.drawRect(rect, paint)
}

<span class="comment">// âœ… æˆå‘˜å˜é‡å¤ç”¨</span>
<span class="keyword">private val</span> paint = Paint()
<span class="keyword">private val</span> rect = Rect()

<span class="keyword">override fun</span> onDraw(canvas: Canvas) {
    rect.set(0, 0, width, height)
    canvas.drawRect(rect, paint)
}</code></pre>
        </section>

        <section id="checklist" class="section">
            <h2>ä¼˜åŒ–æ£€æŸ¥æ¸…å•</h2>

            <div class="cards">
                <div class="card">
                    <h3">ğŸ” å¼€å‘é˜¶æ®µ</h3>
                        <ul>
                            <li>âœ… é›†æˆLeakCanary</li>
                            <li>âœ… å®šæœŸProfileræ£€æŸ¥</li>
                            <li>âœ… ä»£ç Reviewå…³æ³¨å†…å­˜</li>
                            <li>âœ… å¤§å›¾æŒ‰éœ€åŠ è½½</li>
                        </ul>
                </div>
                <div class="card">
                    <h3">ğŸ“± Activity/Fragment</h3>
                        <ul>
                            <li>âœ… é¿å…é™æ€æŒæœ‰</li>
                            <li>âœ… onDestroyæ¸…ç†èµ„æº</li>
                            <li>âœ… Handlerä½¿ç”¨å¼±å¼•ç”¨</li>
                            <li>âœ… æ³¨é”€æ‰€æœ‰ç›‘å¬</li>
                        </ul>
                </div>
                <div class="card">
                    <h3">ğŸ–¼ï¸ å›¾ç‰‡å¤„ç†</h3>
                        <ul>
                            <li>âœ… ä½¿ç”¨Glide/Coil</li>
                            <li>âœ… é€‚å½“é™é‡‡æ ·</li>
                            <li>âœ… è€ƒè™‘RGB_565</li>
                            <li>âœ… åŠæ—¶é‡Šæ”¾Bitmap</li>
                        </ul>
                </div>
                <div class="card">
                    <h3">âš¡ æ€§èƒ½ä¼˜åŒ–</h3>
                        <ul>
                            <li>âœ… é¿å…onDrawåˆ†é…</li>
                            <li>âœ… ä½¿ç”¨å¯¹è±¡æ± </li>
                            <li>âœ… SparseArrayæ›¿ä»£HashMap</li>
                            <li>âœ… StringBuilderæ‹¼æ¥</li>
                        </ul>
                </div>
            </div>

            <div class="tip"><strong>ğŸ“Š å†…å­˜ä¼˜åŒ–ç›®æ ‡</strong>
                <p style="margin-top:8px">â€¢ åº”ç”¨å†…å­˜ < maxMemoryçš„70%<br>
                        â€¢ æ— å†…å­˜æ³„æ¼ï¼ˆLeakCanaryé›¶æŠ¥è­¦ï¼‰<br>
                        â€¢ GCé¢‘ç‡ < 1æ¬¡/ç§’<br>
                            â€¢ å†…å­˜æ›²çº¿å¹³ç¨³æ— é”¯é½¿</p>
            </div>
        </section>
    </div>
    <script>document.querySelectorAll('.toc a').forEach(a => a.addEventListener('click', e => { e.preventDefault(); document.querySelector(a.getAttribute('href')).scrollIntoView({ behavior: 'smooth' }) }))</script>
</body>

</html>