<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Androidè§†å›¾æ¸²æŸ“æµç¨‹ - å¿«é€ŸæŸ¥è¯¢æ‰‹å†Œ</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0d1117;
            --bg2: #161b22;
            --bg3: #21262d;
            --text: #e6edf3;
            --text2: #8b949e;
            --blue: #58a6ff;
            --green: #3fb950;
            --purple: #a371f7;
            --orange: #d29922;
            --cyan: #39c5cf;
            --pink: #f778ba;
            --border: #30363d
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        body {
            font-family: 'Inter', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.7
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 40px 24px
        }

        .hero {
            text-align: center;
            padding: 48px 24px;
            margin-bottom: 48px;
            background: linear-gradient(135deg, rgba(88, 166, 255, 0.15), rgba(163, 113, 247, 0.15));
            border-radius: 16px;
            border: 1px solid var(--border)
        }

        .hero h1 {
            font-size: 34px;
            margin-bottom: 12px;
            background: linear-gradient(135deg, var(--blue), var(--purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent
        }

        .hero p {
            color: var(--text2);
            font-size: 16px
        }

        .section {
            margin-bottom: 48px
        }

        .section h2 {
            font-size: 22px;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--border);
            display: flex;
            align-items: center;
            gap: 10px
        }

        .section h2::before {
            content: '';
            width: 4px;
            height: 22px;
            background: linear-gradient(var(--blue), var(--purple));
            border-radius: 2px
        }

        .section h3 {
            font-size: 18px;
            margin: 24px 0 16px;
            color: var(--blue)
        }

        p {
            margin-bottom: 16px;
            color: var(--text2)
        }

        code {
            font-family: 'JetBrains Mono', monospace;
            background: var(--bg3);
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 13px;
            color: var(--cyan)
        }

        pre {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            overflow-x: auto;
            font-size: 13px;
            line-height: 1.8;
            margin: 16px 0
        }

        pre code {
            background: none;
            padding: 0;
            color: var(--text)
        }

        .comment {
            color: var(--text2)
        }

        .keyword {
            color: var(--purple)
        }

        .string {
            color: var(--green)
        }

        .cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
            margin: 20px 0
        }

        .card {
            background: var(--bg2);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            transition: all .2s
        }

        .card:hover {
            border-color: var(--blue);
            transform: translateY(-2px)
        }

        .card h3 {
            font-size: 16px;
            color: var(--blue);
            margin-bottom: 12px
        }

        .card p,
        .card li {
            font-size: 14px;
            color: var(--text2);
            margin: 0
        }

        .card ul {
            margin: 8px 0 0 16px
        }

        .tip {
            background: rgba(88, 166, 255, 0.1);
            border: 1px solid rgba(88, 166, 255, 0.3);
            border-radius: 12px;
            padding: 16px 20px;
            margin: 20px 0
        }

        .tip.warn {
            background: rgba(210, 153, 34, 0.1);
            border-color: rgba(210, 153, 34, 0.3)
        }

        .tip.success {
            background: rgba(63, 185, 80, 0.1);
            border-color: rgba(63, 185, 80, 0.3)
        }

        .tip strong {
            display: block;
            margin-bottom: 6px;
            color: var(--blue)
        }

        .tip.warn strong {
            color: var(--orange)
        }

        .tip.success strong {
            color: var(--green)
        }

        .flow {
            background: var(--bg2);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            margin: 20px 0
        }

        .flow-title {
            font-size: 14px;
            color: var(--text2);
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 1px
        }

        .flow-steps {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 8px
        }

        .flow-step {
            background: var(--bg3);
            border-radius: 8px;
            padding: 10px 14px;
            font-size: 13px;
            font-weight: 500
        }

        .flow-arrow {
            color: var(--blue);
            font-size: 16px
        }

        .timeline {
            position: relative;
            padding-left: 32px;
            margin: 24px 0
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--border)
        }

        .timeline-item {
            position: relative;
            margin-bottom: 20px;
            padding: 16px 20px;
            background: var(--bg2);
            border: 1px solid var(--border);
            border-radius: 12px
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -28px;
            top: 20px;
            width: 12px;
            height: 12px;
            background: var(--blue);
            border-radius: 50%;
            border: 2px solid var(--bg)
        }

        .timeline-item h4 {
            font-size: 15px;
            margin-bottom: 8px;
            color: var(--text)
        }

        .timeline-item p {
            font-size: 13px;
            color: var(--text2);
            margin: 0
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            background: var(--bg2);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border);
            margin: 16px 0
        }

        th {
            background: var(--bg3);
            padding: 14px 16px;
            text-align: left;
            font-weight: 600
        }

        td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border)
        }

        tr:last-child td {
            border-bottom: none
        }

        .toc {
            position: fixed;
            top: 40px;
            right: 40px;
            width: 200px;
            background: var(--bg2);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px
        }

        .toc h3 {
            font-size: 12px;
            color: var(--text2);
            text-transform: uppercase;
            margin-bottom: 12px
        }

        .toc a {
            display: block;
            padding: 6px 0;
            color: var(--text2);
            text-decoration: none;
            font-size: 13px
        }

        .toc a:hover {
            color: var(--blue)
        }

        @media(max-width:1200px) {
            .toc {
                display: none
            }
        }

        @media(max-width:768px) {
            .container {
                padding: 24px 16px
            }

            .hero h1 {
                font-size: 26px
            }

            .cards {
                grid-template-columns: 1fr
            }

            .flow-steps {
                flex-direction: column
            }

            .flow-arrow {
                transform: rotate(90deg)
            }
        }
    </style>
</head>

<body>
    <nav class="toc">
        <h3>ç›®å½•</h3><a href="#overview">æ¸²æŸ“æ¦‚è§ˆ</a><a href="#measure">Measureæµ‹é‡</a><a href="#layout">Layoutå¸ƒå±€</a><a
            href="#draw">Drawç»˜åˆ¶</a><a href="#vsync">VSyncæœºåˆ¶</a><a href="#hwui">ç¡¬ä»¶åŠ é€Ÿ</a><a
            href="#surface">Surfaceç³»ç»Ÿ</a><a href="#optimize">æ€§èƒ½ä¼˜åŒ–</a>
    </nav>

    <div class="container">
        <div class="hero">
            <h1>ğŸ¨ Androidè§†å›¾æ¸²æŸ“æµç¨‹</h1>
            <p>ä»ä»£ç åˆ°å±å¹• - Viewç»˜åˆ¶åŸç†ä¸æ¸²æŸ“ç®¡çº¿è¯¦è§£</p>
        </div>

        <section id="overview" class="section">
            <h2>æ¸²æŸ“æµç¨‹æ¦‚è§ˆ</h2>
            <p>Androidè§†å›¾æ¸²æŸ“æ˜¯å°†Viewæ ‘è½¬æ¢ä¸ºå±å¹•åƒç´ çš„è¿‡ç¨‹ï¼Œæ ¸å¿ƒæµç¨‹åŒ…æ‹¬<strong>æµ‹é‡(Measure)â†’å¸ƒå±€(Layout)â†’ç»˜åˆ¶(Draw)</strong>ä¸‰ä¸ªé˜¶æ®µã€‚</p>

            <div class="flow">
                <div class="flow-title">æ¸²æŸ“æ ¸å¿ƒæµç¨‹</div>
                <div class="flow-steps">
                    <div class="flow-step">ğŸ“ Measure</div>
                    <span class="flow-arrow">â†’</span>
                    <div class="flow-step">ğŸ“ Layout</div>
                    <span class="flow-arrow">â†’</span>
                    <div class="flow-step">ğŸ¨ Draw</div>
                    <span class="flow-arrow">â†’</span>
                    <div class="flow-step">ğŸ–¥ï¸ SurfaceFlinger</div>
                    <span class="flow-arrow">â†’</span>
                    <div class="flow-step">ğŸ“º æ˜¾ç¤ºå±</div>
                </div>
            </div>

            <h3>æ¸²æŸ“è§¦å‘å…¥å£</h3>
            <pre><code><span class="comment">// è§¦å‘æ¸²æŸ“çš„æ–¹å¼</span>
view.invalidate()      <span class="comment">// åªè§¦å‘ Draw</span>
view.requestLayout()   <span class="comment">// è§¦å‘ Measure â†’ Layout â†’ Draw</span>
view.postInvalidate()  <span class="comment">// åœ¨éUIçº¿ç¨‹è§¦å‘é‡ç»˜</span>

<span class="comment">// ViewRootImpl.performTraversals() - æ ¸å¿ƒå…¥å£</span>
<span class="keyword">private void</span> performTraversals() {
    performMeasure(childWidthMeasureSpec, childHeightMeasureSpec);
    performLayout(lp, mWidth, mHeight);
    performDraw();
}</code></pre>

            <div class="cards">
                <div class="card">
                    <h3>ğŸŒ³ View Tree</h3>
                    <p>ç•Œé¢ç”±DecorViewä¸ºæ ¹çš„Viewæ ‘ç»„æˆï¼ŒViewRootImplè´Ÿè´£ç®¡ç†æ•´æ£µæ ‘çš„éå†æ¸²æŸ“</p>
                </div>
                <div class="card">
                    <h3">â±ï¸ 16msç›®æ ‡</h3>
                        <p>60fpsåˆ·æ–°ç‡è¦æ±‚æ¯å¸§åœ¨16.67mså†…å®Œæˆï¼Œå¦åˆ™é€ æˆæ‰å¸§å¡é¡¿</p>
                </div>
                <div class="card">
                    <h3">ğŸ”„ åŒç¼“å†²</h3>
                        <p>åå°ç¼“å†²åŒºç»˜åˆ¶å®Œæˆåä¸å‰å°äº¤æ¢ï¼Œé¿å…ç”»é¢æ’•è£‚</p>
                </div>
            </div>
        </section>

        <section id="measure" class="section">
            <h2>Measure æµ‹é‡é˜¶æ®µ</h2>
            <p>ç¡®å®šæ¯ä¸ªViewçš„å®½é«˜å°ºå¯¸ï¼Œé€šè¿‡MeasureSpecå‘ä¸‹ä¼ é€’çº¦æŸï¼Œå­Viewå‘ä¸ŠæŠ¥å‘Šæµ‹é‡ç»“æœã€‚</p>

            <h3>MeasureSpec æ¨¡å¼</h3>
            <table>
                <thead>
                    <tr>
                        <th>æ¨¡å¼</th>
                        <th>å«ä¹‰</th>
                        <th>å¯¹åº”åœºæ™¯</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>EXACTLY</code></td>
                        <td>ç²¾ç¡®å°ºå¯¸ï¼ŒViewå¿…é¡»ä½¿ç”¨è¯¥å€¼</td>
                        <td>match_parent æˆ– å…·ä½“dpå€¼</td>
                    </tr>
                    <tr>
                        <td><code>AT_MOST</code></td>
                        <td>æœ€å¤§å°ºå¯¸ï¼ŒViewä¸èƒ½è¶…è¿‡è¯¥å€¼</td>
                        <td>wrap_content</td>
                    </tr>
                    <tr>
                        <td><code>UNSPECIFIED</code></td>
                        <td>æ— é™åˆ¶ï¼ŒViewæƒ³å¤šå¤§å°±å¤šå¤§</td>
                        <td>ScrollViewå†…çš„å­View</td>
                    </tr>
                </tbody>
            </table>

            <pre><code><span class="comment">// MeasureSpec = Mode + Size (32ä½int)</span>
<span class="keyword">int</span> mode = MeasureSpec.getMode(measureSpec);
<span class="keyword">int</span> size = MeasureSpec.getSize(measureSpec);

<span class="comment">// Viewçš„æµ‹é‡æµç¨‹</span>
<span class="keyword">protected void</span> onMeasure(<span class="keyword">int</span> widthSpec, <span class="keyword">int</span> heightSpec) {
    <span class="comment">// 1. æ ¹æ®MeasureSpecè®¡ç®—è‡ªèº«å°ºå¯¸</span>
    <span class="keyword">int</span> width = calculateWidth(widthSpec);
    <span class="keyword">int</span> height = calculateHeight(heightSpec);
    
    <span class="comment">// 2. å¿…é¡»è°ƒç”¨setMeasuredDimensionä¿å­˜ç»“æœ</span>
    setMeasuredDimension(width, height);
}

<span class="comment">// ViewGroupéœ€è¦æµ‹é‡å­View</span>
<span class="keyword">protected void</span> onMeasure(...) {
    <span class="keyword">for</span> (View child : children) {
        measureChild(child, widthSpec, heightSpec);
    }
    <span class="comment">// æ ¹æ®å­Viewå°ºå¯¸è®¡ç®—è‡ªèº«å°ºå¯¸</span>
}</code></pre>

            <div class="tip warn"><strong>âš ï¸ æµ‹é‡æ€§èƒ½é™·é˜±</strong>
                <p style="margin-top:8px">é¿å…åœ¨onMeasureä¸­åˆ›å»ºå¯¹è±¡æˆ–æ‰§è¡Œè€—æ—¶æ“ä½œï¼Œå› ä¸ºå¯èƒ½è¢«å¤šæ¬¡è°ƒç”¨ã€‚RelativeLayoutåœ¨å¤æ‚å¸ƒå±€æ—¶ä¼šæµ‹é‡ä¸¤æ¬¡ã€‚</p>
            </div>
        </section>

        <section id="layout" class="section">
            <h2>Layout å¸ƒå±€é˜¶æ®µ</h2>
            <p>ç¡®å®šæ¯ä¸ªViewåœ¨çˆ¶å®¹å™¨ä¸­çš„ä½ç½®ï¼ˆleft, top, right, bottomåæ ‡ï¼‰ã€‚</p>

            <pre><code><span class="comment">// ViewGroup.layout() â†’ onLayout()</span>
<span class="keyword">protected void</span> onLayout(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b) {
    <span class="keyword">int</span> childLeft = paddingLeft;
    <span class="keyword">int</span> childTop = paddingTop;
    
    <span class="keyword">for</span> (View child : children) {
        <span class="keyword">int</span> childWidth = child.getMeasuredWidth();
        <span class="keyword">int</span> childHeight = child.getMeasuredHeight();
        
        <span class="comment">// ç¡®å®šå­Viewçš„ä½ç½®</span>
        child.layout(childLeft, childTop, 
                     childLeft + childWidth, 
                     childTop + childHeight);
        
        childTop += childHeight + margin;
    }
}</code></pre>

            <div class="cards">
                <div class="card">
                    <h3">ğŸ“ ä½ç½®ç¡®å®š</h3>
                        <p>layout()æ–¹æ³•è®¾ç½®Viewçš„mLeft, mTop, mRight, mBottomå››ä¸ªå€¼</p>
                </div>
                <div class="card">
                    <h3">ğŸ”¢ åæ ‡ç³»</h3>
                        <p>ç›¸å¯¹äºçˆ¶å®¹å™¨çš„å·¦ä¸Šè§’ï¼ŒXè½´å‘å³ä¸ºæ­£ï¼ŒYè½´å‘ä¸‹ä¸ºæ­£</p>
                </div>
                <div class="card">
                    <h3">ğŸ“ è·å–ä½ç½®</h3>
                        <p>getLeft()/getTop()/getWidth()/getHeight() è·å–å¸ƒå±€åçš„å€¼</p>
                </div>
            </div>
        </section>

        <section id="draw" class="section">
            <h2>Draw ç»˜åˆ¶é˜¶æ®µ</h2>
            <p>å°†Viewçš„å†…å®¹ç»˜åˆ¶åˆ°Canvasä¸Šï¼Œæœ€ç»ˆæ¸²æŸ“åˆ°å±å¹•ã€‚</p>

            <h3>ç»˜åˆ¶é¡ºåºï¼ˆ6æ­¥ï¼‰</h3>
            <div class="timeline">
                <div class="timeline-item">
                    <h4>â‘  drawBackground()</h4>
                    <p>ç»˜åˆ¶èƒŒæ™¯</p>
                </div>
                <div class="timeline-item">
                    <h4>â‘¡ onDraw()</h4>
                    <p>ç»˜åˆ¶Viewè‡ªèº«å†…å®¹ï¼ˆè‡ªå®šä¹‰Viewä¸»è¦é‡å†™æ­¤æ–¹æ³•ï¼‰</p>
                </div>
                <div class="timeline-item">
                    <h4>â‘¢ dispatchDraw()</h4>
                    <p>ç»˜åˆ¶å­Viewï¼ˆViewGroupé‡å†™ï¼‰</p>
                </div>
                <div class="timeline-item">
                    <h4>â‘£ onDrawForeground()</h4>
                    <p>ç»˜åˆ¶å‰æ™¯ã€æ»šåŠ¨æ¡ç­‰è£…é¥°</p>
                </div>
            </div>

            <pre><code><span class="comment">// è‡ªå®šä¹‰Viewç»‘å®šç¤ºä¾‹</span>
<span class="keyword">class</span> CustomView : View {
    <span class="keyword">override fun</span> onDraw(canvas: Canvas) {
        <span class="keyword">super</span>.onDraw(canvas)
        
        <span class="comment">// ç»˜åˆ¶åœ†å½¢</span>
        canvas.drawCircle(centerX, centerY, radius, paint)
        
        <span class="comment">// ç»˜åˆ¶æ–‡å­—</span>
        canvas.drawText(<span class="string">"Hello"</span>, x, y, textPaint)
        
        <span class="comment">// ç»˜åˆ¶è·¯å¾„</span>
        canvas.drawPath(path, pathPaint)
    }
}</code></pre>

            <h3>Canvas æ ¸å¿ƒAPI</h3>
            <table>
                <thead>
                    <tr>
                        <th>æ–¹æ³•</th>
                        <th>åŠŸèƒ½</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>drawRect/Circle/Oval</code></td>
                        <td>ç»˜åˆ¶åŸºæœ¬å›¾å½¢</td>
                    </tr>
                    <tr>
                        <td><code>drawBitmap</code></td>
                        <td>ç»˜åˆ¶ä½å›¾</td>
                    </tr>
                    <tr>
                        <td><code>drawText</code></td>
                        <td>ç»˜åˆ¶æ–‡å­—</td>
                    </tr>
                    <tr>
                        <td><code>drawPath</code></td>
                        <td>ç»˜åˆ¶è·¯å¾„</td>
                    </tr>
                    <tr>
                        <td><code>save/restore</code></td>
                        <td>ä¿å­˜/æ¢å¤ç”»å¸ƒçŠ¶æ€</td>
                    </tr>
                    <tr>
                        <td><code>translate/rotate/scale</code></td>
                        <td>ç”»å¸ƒå˜æ¢</td>
                    </tr>
                    <tr>
                        <td><code>clipRect/clipPath</code></td>
                        <td>è£å‰ªç”»å¸ƒ</td>
                    </tr>
                </tbody>
            </table>
        </section>

        <section id="vsync" class="section">
            <h2>VSync ä¸ Choreographer</h2>
            <p>VSyncï¼ˆå‚ç›´åŒæ­¥ï¼‰ä¿¡å·åè°ƒCPU/GPUæ¸²æŸ“ä¸å±å¹•åˆ·æ–°ï¼ŒChoreographerè´Ÿè´£è°ƒåº¦å¸§å›è°ƒã€‚</p>

            <div class="flow">
                <div class="flow-title">å¸§æ¸²æŸ“æ—¶åº</div>
                <div class="flow-steps">
                    <div class="flow-step">VSyncä¿¡å·</div>
                    <span class="flow-arrow">â†’</span>
                    <div class="flow-step">Choreographerå›è°ƒ</div>
                    <span class="flow-arrow">â†’</span>
                    <div class="flow-step">å¤„ç†Input</div>
                    <span class="flow-arrow">â†’</span>
                    <div class="flow-step">å¤„ç†Animation</div>
                    <span class="flow-arrow">â†’</span>
                    <div class="flow-step">æ‰§è¡ŒTraversal</div>
                </div>
            </div>

            <pre><code><span class="comment">// Choreographer å¸§å›è°ƒ</span>
Choreographer.getInstance().postFrameCallback { frameTimeNanos ->
    <span class="comment">// åœ¨ä¸‹ä¸€ä¸ªVSyncä¿¡å·æ—¶æ‰§è¡Œ</span>
    <span class="comment">// frameTimeNanos: å¸§å¼€å§‹çš„æ—¶é—´æˆ³</span>
    updateAnimation(frameTimeNanos)
}

<span class="comment">// å›è°ƒç±»å‹ä¼˜å…ˆçº§</span>
<span class="comment">// CALLBACK_INPUT (0)      - è¾“å…¥äº‹ä»¶</span>
<span class="comment">// CALLBACK_ANIMATION (1)  - åŠ¨ç”»</span>
<span class="comment">// CALLBACK_TRAVERSAL (2)  - Viewéå†</span>
<span class="comment">// CALLBACK_COMMIT (3)     - æäº¤</span></code></pre>

            <div class="tip"><strong>â±ï¸ å¸§æ—¶é—´é¢„ç®— (60fps)</strong>
                <p style="margin-top:8px">VSyncå‘¨æœŸ: 16.67ms<br>
                    Inputå¤„ç†: ~2ms<br>
                    åŠ¨ç”»è®¡ç®—: ~2ms<br>
                    Measure+Layout: ~4ms<br>
                    Draw: ~4ms<br>
                    GPUæ¸²æŸ“: ~4ms</p>
            </div>
        </section>

        <section id="hwui" class="section">
            <h2>ç¡¬ä»¶åŠ é€Ÿæ¸²æŸ“</h2>
            <p>Android 3.0èµ·å¼•å…¥ç¡¬ä»¶åŠ é€Ÿï¼Œä½¿ç”¨GPUæ‰§è¡Œç»‘å®šæ“ä½œï¼Œæ˜¾è‘—æå‡æ¸²æŸ“æ€§èƒ½ã€‚</p>

            <div class="cards">
                <div class="card">
                    <h3">ğŸ’» è½¯ä»¶æ¸²æŸ“</h3>
                        <p>CPUç»‘å®šåˆ°Bitmap â†’ é€šè¿‡Surfaceæäº¤<br>æ¯æ¬¡ç»˜åˆ¶æ•´ä¸ªViewæ ‘</p>
                </div>
                <div class="card">
                    <h3">ğŸ® ç¡¬ä»¶æ¸²æŸ“</h3>
                        <p>æ„å»ºDisplayList â†’ GPUæ‰§è¡Œ<br>ä»…é‡ç»˜å˜åŒ–çš„éƒ¨åˆ†</p>
                </div>
            </div>

            <h3>RenderThread æ¸²æŸ“çº¿ç¨‹</h3>
            <pre><code><span class="comment">// ç¡¬ä»¶åŠ é€Ÿæ¸²æŸ“æµç¨‹</span>
<span class="string">UI Thread:</span>
  â””â”€ View.draw() 
      â””â”€ æ„å»º/æ›´æ–° DisplayList (RenderNode)
          â””â”€ è®°å½•ç»‘å®šå‘½ä»¤ (Canvas â†’ RecordingCanvas)

<span class="string">Render Thread:</span>
  â””â”€ åŒæ­¥ DisplayList
      â””â”€ æ‰§è¡Œ OpenGL/Vulkan å‘½ä»¤
          â””â”€ è¾“å‡ºåˆ° Surface Buffer

<span class="comment">// æ£€æŸ¥Viewæ˜¯å¦ç¡¬ä»¶åŠ é€Ÿ</span>
view.isHardwareAccelerated()

<span class="comment">// æŸäº›æ“ä½œä¸æ”¯æŒç¡¬ä»¶åŠ é€Ÿ</span>
<span class="comment">// Canvas.drawBitmapMesh(), Canvas.drawPicture() ç­‰</span></code></pre>

            <div class="tip success"><strong>âœ… ç¡¬ä»¶åŠ é€Ÿä¼˜åŠ¿</strong>
                <p style="margin-top:8px">â€¢ DisplayListç¼“å­˜ï¼Œé¿å…é‡å¤ç»˜åˆ¶<br>
                    â€¢ RenderThreadä¸UIçº¿ç¨‹å¹¶è¡Œ<br>
                    â€¢ GPUå¹¶è¡Œå¤„ç†åƒç´ <br>
                    â€¢ æ”¯æŒæ›´å¤æ‚çš„åŠ¨ç”»æ•ˆæœ</p>
            </div>
        </section>

        <section id="surface" class="section">
            <h2>Surface ä¸ SurfaceFlinger</h2>
            <p>Surfaceæ˜¯ä¸€å—å›¾å½¢ç¼“å†²åŒºï¼ŒAppç»‘å®šåˆ°Surfaceï¼ŒSurfaceFlingerè´Ÿè´£åˆæˆå¤šä¸ªSurfaceå¹¶è¾“å‡ºåˆ°å±å¹•ã€‚</p>

            <div class="flow">
                <div class="flow-title">Surfaceæ¸²æŸ“ç®¡çº¿</div>
                <div class="flow-steps">
                    <div class="flow-step">Appç»‘åˆ¶</div>
                    <span class="flow-arrow">â†’</span>
                    <div class="flow-step">BufferQueue</div>
                    <span class="flow-arrow">â†’</span>
                    <div class="flow-step">SurfaceFlinger</div>
                    <span class="flow-arrow">â†’</span>
                    <div class="flow-step">HWComposer</div>
                    <span class="flow-arrow">â†’</span>
                    <div class="flow-step">Display</div>
                </div>
            </div>

            <h3>æ ¸å¿ƒç»„ä»¶</h3>
            <table>
                <thead>
                    <tr>
                        <th>ç»„ä»¶</th>
                        <th>èŒè´£</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>Surface</code></td>
                        <td>åº”ç”¨ä¾§çš„å›¾å½¢ç¼“å†²åŒºå¥æŸ„</td>
                    </tr>
                    <tr>
                        <td><code>BufferQueue</code></td>
                        <td>ç”Ÿäº§è€…-æ¶ˆè´¹è€…é˜Ÿåˆ—ï¼Œç®¡ç†GraphicBuffer</td>
                    </tr>
                    <tr>
                        <td><code>SurfaceFlinger</code></td>
                        <td>ç³»ç»ŸæœåŠ¡ï¼Œåˆæˆå¤šä¸ªLayer</td>
                    </tr>
                    <tr>
                        <td><code>HWComposer</code></td>
                        <td>ç¡¬ä»¶åˆæˆå™¨ï¼Œå†³å®šGPU/Overlayåˆæˆ</td>
                    </tr>
                    <tr>
                        <td><code>Layer</code></td>
                        <td>SurfaceFlingerä¸­çš„å›¾å±‚æŠ½è±¡</td>
                    </tr>
                </tbody>
            </table>

            <pre><code><span class="comment">// å…¸å‹çš„ä¸€å¸§æ¸²æŸ“æµç¨‹</span>
1. Appé€šè¿‡dequeueBufferè·å–ç©ºé—²ç¼“å†²åŒº
2. Appåœ¨ç¼“å†²åŒºä¸Šç»‘åˆ¶å†…å®¹
3. Appé€šè¿‡queueBufferæäº¤ç¼“å†²åŒº
4. SurfaceFlingeræ”¶åˆ°VSyncä¿¡å·
5. SurfaceFlingerä»å„Appè·å–æœ€æ–°Buffer
6. HWComposerå†³å®šåˆæˆç­–ç•¥
7. åˆæˆç»“æœè¾“å‡ºåˆ°Display</code></pre>
        </section>

        <section id="optimize" class="section">
            <h2>æ¸²æŸ“æ€§èƒ½ä¼˜åŒ–</h2>

            <div class="cards">
                <div class="card">
                    <h3">ğŸ“‰ å‡å°‘å±‚çº§</h3>
                        <p>ä½¿ç”¨ConstraintLayoutå‡å°‘åµŒå¥—ï¼Œç”¨mergeæ ‡ç­¾ä¼˜åŒ–include</p>
                </div>
                <div class="card">
                    <h3">ğŸš« é¿å…è¿‡åº¦ç»˜åˆ¶</h3>
                        <p>ç§»é™¤ä¸å¯è§èƒŒæ™¯ï¼Œä½¿ç”¨clipRectè£å‰ªï¼Œå¼€å‘è€…é€‰é¡¹æŸ¥çœ‹è¿‡åº¦ç»˜åˆ¶</p>
                </div>
                <div class="card">
                    <h3">ğŸ“‹ å¤ç”¨å¸ƒå±€</h3>
                        <p>RecyclerViewå¤ç”¨ViewHolderï¼ŒViewStubå»¶è¿ŸåŠ è½½</p>
                </div>
                <div class="card">
                    <h3">âš¡ å‡å°‘invalidate</h3>
                        <p>ä½¿ç”¨invalidate(Rect)å±€éƒ¨åˆ·æ–°ï¼Œé¿å…é¢‘ç¹è°ƒç”¨</p>
                </div>
            </div>

            <h3>æ£€æµ‹å·¥å…·</h3>
            <table>
                <thead>
                    <tr>
                        <th>å·¥å…·</th>
                        <th>ç”¨é€”</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Layout Inspector</td>
                        <td>æŸ¥çœ‹Viewå±‚çº§ç»“æ„</td>
                    </tr>
                    <tr>
                        <td>GPUå‘ˆç°æ¨¡å¼åˆ†æ</td>
                        <td>æŸ¥çœ‹æ¯å¸§æ¸²æŸ“æ—¶é—´åˆ†å¸ƒ</td>
                    </tr>
                    <tr>
                        <td>è¿‡åº¦ç»˜åˆ¶è°ƒè¯•</td>
                        <td>æ£€æµ‹é‡å¤ç»˜åˆ¶åŒºåŸŸ</td>
                    </tr>
                    <tr>
                        <td>Systrace</td>
                        <td>åˆ†æå¸§æ¸²æŸ“è¯¦ç»†æ—¶åº</td>
                    </tr>
                    <tr>
                        <td>Perfetto</td>
                        <td>å…¨é¢çš„æ€§èƒ½è¿½è¸ª</td>
                    </tr>
                </tbody>
            </table>

            <pre><code><span class="comment">// ä¼˜åŒ–ç¤ºä¾‹ï¼šä½¿ç”¨clipRecté¿å…è¿‡åº¦ç»˜åˆ¶</span>
<span class="keyword">override fun</span> onDraw(canvas: Canvas) {
    <span class="comment">// åªç»˜åˆ¶å¯è§åŒºåŸŸ</span>
    canvas.clipRect(visibleRect)
    <span class="keyword">super</span>.onDraw(canvas)
}

<span class="comment">// ä½¿ç”¨setWillNotDrawä¼˜åŒ–</span>
<span class="keyword">init</span> {
    setWillNotDraw(<span class="keyword">true</span>)  <span class="comment">// ViewGroupé»˜è®¤ä¸ç»˜åˆ¶è‡ªèº«</span>
}</code></pre>

            <div class="tip"><strong>ğŸ“Š æ€§èƒ½æŒ‡æ ‡</strong>
                <p style="margin-top:8px">â€¢ <strong>Janky frames</strong>: è¶…è¿‡16msçš„å¸§å æ¯”åº” < 1%<br>
                        â€¢ <strong>è¿‡åº¦ç»˜åˆ¶</strong>: è“è‰²(1x)å¯æ¥å—ï¼Œçº¢è‰²(4x+)éœ€ä¼˜åŒ–<br>
                        â€¢ <strong>Viewå±‚çº§</strong>: å»ºè®®ä¸è¶…è¿‡10å±‚</p>
            </div>
        </section>

        <div class="tip success"><strong>ğŸ¯ æ€»ç»“ï¼šæ¸²æŸ“å…³é”®è·¯å¾„</strong>
            <p style="margin-top:8px">
                <code>setContentView</code> â†’ <code>LayoutInflaterè§£æXML</code> â†’ <code>åˆ›å»ºViewæ ‘</code> â†’<br>
                <code>ViewRootImpl.performTraversals</code> â†’ <code>Measureâ†’Layoutâ†’Draw</code> â†’<br>
                <code>æ„å»ºDisplayList</code> â†’ <code>RenderThreadæ‰§è¡ŒGPUå‘½ä»¤</code> â†’<br>
                <code>Bufferå…¥é˜Ÿ</code> â†’ <code>SurfaceFlingeråˆæˆ</code> â†’ <code>æ˜¾ç¤º</code>
            </p>
        </div>
    </div>
    <script>document.querySelectorAll('.toc a').forEach(a => a.addEventListener('click', e => { e.preventDefault(); document.querySelector(a.getAttribute('href')).scrollIntoView({ behavior: 'smooth' }) }))</script>
</body>

</html>