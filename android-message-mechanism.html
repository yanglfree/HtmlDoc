<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Androidæ¶ˆæ¯æœºåˆ¶å¿«é€ŸæŸ¥è¯¢æ‰‹å†Œ</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0d1117;
            --bg2: #161b22;
            --bg3: #21262d;
            --text: #e6edf3;
            --text2: #8b949e;
            --blue: #58a6ff;
            --green: #3fb950;
            --purple: #a371f7;
            --orange: #d29922;
            --cyan: #39c5cf;
            --red: #f85149;
            --border: #30363d
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        body {
            font-family: 'Inter', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.7
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 40px 24px
        }

        .hero {
            text-align: center;
            padding: 48px 24px;
            margin-bottom: 48px;
            background: linear-gradient(135deg, rgba(63, 185, 80, 0.15), rgba(88, 166, 255, 0.15));
            border-radius: 16px;
            border: 1px solid var(--border)
        }

        .hero h1 {
            font-size: 36px;
            margin-bottom: 12px;
            background: linear-gradient(135deg, var(--green), var(--blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent
        }

        .hero p {
            color: var(--text2);
            font-size: 16px
        }

        .section {
            margin-bottom: 48px
        }

        .section h2 {
            font-size: 22px;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--border);
            display: flex;
            align-items: center;
            gap: 10px
        }

        .section h2::before {
            content: '';
            width: 4px;
            height: 22px;
            background: linear-gradient(var(--green), var(--blue));
            border-radius: 2px
        }

        .section h3 {
            font-size: 18px;
            margin: 24px 0 16px;
            color: var(--blue)
        }

        p {
            margin-bottom: 16px;
            color: var(--text2)
        }

        code {
            font-family: 'JetBrains Mono', monospace;
            background: var(--bg3);
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 13px;
            color: var(--cyan)
        }

        pre {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            overflow-x: auto;
            font-size: 13px;
            line-height: 1.8;
            margin: 16px 0
        }

        pre code {
            background: none;
            padding: 0;
            color: var(--text)
        }

        .comment {
            color: var(--text2)
        }

        .keyword {
            color: var(--purple)
        }

        .string {
            color: var(--green)
        }

        .type {
            color: var(--cyan)
        }

        .cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
            margin: 20px 0
        }

        .card {
            background: var(--bg2);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            transition: all .2s
        }

        .card:hover {
            border-color: var(--green);
            transform: translateY(-2px)
        }

        .card h3 {
            font-size: 16px;
            color: var(--green);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px
        }

        .card p {
            font-size: 14px;
            color: var(--text2);
            margin: 0
        }

        .card ul {
            margin: 8px 0 0 16px;
            font-size: 13px;
            color: var(--text2)
        }

        .tip {
            background: rgba(88, 166, 255, 0.1);
            border: 1px solid rgba(88, 166, 255, 0.3);
            border-radius: 12px;
            padding: 16px 20px;
            margin: 20px 0
        }

        .tip.warn {
            background: rgba(210, 153, 34, 0.1);
            border-color: rgba(210, 153, 34, 0.3)
        }

        .tip.success {
            background: rgba(63, 185, 80, 0.1);
            border-color: rgba(63, 185, 80, 0.3)
        }

        .tip strong {
            display: block;
            margin-bottom: 6px
        }

        .flow {
            background: var(--bg2);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            margin: 20px 0
        }

        .flow-title {
            font-size: 14px;
            color: var(--text2);
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 1px
        }

        .flow-steps {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 12px
        }

        .flow-step {
            background: var(--bg3);
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 500
        }

        .flow-arrow {
            color: var(--green);
            font-size: 20px
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            background: var(--bg2);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border);
            margin: 16px 0
        }

        th {
            background: var(--bg3);
            padding: 14px 16px;
            text-align: left;
            font-weight: 600
        }

        td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border)
        }

        tr:last-child td {
            border-bottom: none
        }

        .toc {
            position: fixed;
            top: 40px;
            right: 40px;
            width: 200px;
            background: var(--bg2);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px
        }

        .toc h3 {
            font-size: 12px;
            color: var(--text2);
            text-transform: uppercase;
            margin-bottom: 12px
        }

        .toc a {
            display: block;
            padding: 6px 0;
            color: var(--text2);
            text-decoration: none;
            font-size: 13px
        }

        .toc a:hover {
            color: var(--green)
        }

        @media(max-width:1200px) {
            .toc {
                display: none
            }
        }

        @media(max-width:768px) {
            .container {
                padding: 24px 16px
            }

            .hero h1 {
                font-size: 28px
            }

            .cards {
                grid-template-columns: 1fr
            }

            .flow-steps {
                flex-direction: column
            }

            .flow-arrow {
                transform: rotate(90deg)
            }
        }
    </style>
</head>

<body>
    <nav class="toc">
        <h3>ç›®å½•</h3><a href="#overview">æ ¸å¿ƒæ¦‚å¿µ</a><a href="#handler">Handler</a><a href="#looper">Looper</a><a
            href="#queue">MessageQueue</a><a href="#message">Message</a><a href="#flow">æ¶ˆæ¯æµè½¬</a><a
            href="#thread">çº¿ç¨‹é€šä¿¡</a><a href="#practice">æœ€ä½³å®è·µ</a>
    </nav>

    <div class="container">
        <div class="hero">
            <h1>ğŸ“± Androidæ¶ˆæ¯æœºåˆ¶</h1>
            <p>Handler / Looper / MessageQueue æ ¸å¿ƒåŸç†ä¸ä½¿ç”¨æŒ‡å—</p>
        </div>

        <section id="overview" class="section">
            <h2>æ ¸å¿ƒæ¦‚å¿µ</h2>
            <p>Androidæ¶ˆæ¯æœºåˆ¶æ˜¯Androidç³»ç»Ÿä¸­å®ç°çº¿ç¨‹é—´é€šä¿¡çš„æ ¸å¿ƒæœºåˆ¶ï¼Œä¸»è¦ç”±<strong>Handler</strong>ã€<strong>Looper</strong>ã€<strong>MessageQueue</strong>ã€<strong>Message</strong>å››ä¸ªç»„ä»¶ç»„æˆã€‚
            </p>

            <div class="cards">
                <div class="card">
                    <h3>ğŸ“¨ Handler</h3>
                    <p>æ¶ˆæ¯çš„å‘é€è€…å’Œå¤„ç†è€…</p>
                    <ul>
                        <li>å‘é€æ¶ˆæ¯åˆ°MessageQueue</li>
                        <li>å¤„ç†Looperåˆ†å‘çš„æ¶ˆæ¯</li>
                    </ul>
                </div>
                <div class="card">
                    <h3>ğŸ”„ Looper</h3>
                    <p>æ¶ˆæ¯å¾ªç¯å™¨</p>
                    <ul>
                        <li>ä¸æ–­ä»MessageQueueå–æ¶ˆæ¯</li>
                        <li>å°†æ¶ˆæ¯åˆ†å‘ç»™å¯¹åº”Handler</li>
                    </ul>
                </div>
                <div class="card">
                    <h3>ğŸ“¬ MessageQueue</h3>
                    <p>æ¶ˆæ¯é˜Ÿåˆ—</p>
                    <ul>
                        <li>å­˜å‚¨å¾…å¤„ç†çš„Message</li>
                        <li>æŒ‰æ—¶é—´é¡ºåºæ’åˆ—ï¼ˆå•é“¾è¡¨ï¼‰</li>
                    </ul>
                </div>
                <div class="card">
                    <h3>âœ‰ï¸ Message</h3>
                    <p>æ¶ˆæ¯è½½ä½“</p>
                    <ul>
                        <li>æºå¸¦æ•°æ®ï¼ˆwhat, obj, arg1, arg2ï¼‰</li>
                        <li>è®°å½•ç›®æ ‡Handlerå’Œæ‰§è¡Œæ—¶é—´</li>
                    </ul>
                </div>
            </div>

            <div class="flow">
                <div class="flow-title">æ¶ˆæ¯æœºåˆ¶å·¥ä½œæµç¨‹</div>
                <div class="flow-steps">
                    <div class="flow-step">Handlerå‘é€Message</div>
                    <span class="flow-arrow">â†’</span>
                    <div class="flow-step">Messageå…¥é˜ŸMessageQueue</div>
                    <span class="flow-arrow">â†’</span>
                    <div class="flow-step">Looperå¾ªç¯å–å‡ºMessage</div>
                    <span class="flow-arrow">â†’</span>
                    <div class="flow-step">Handlerå¤„ç†Message</div>
                </div>
            </div>
        </section>

        <section id="handler" class="section">
            <h2>Handler è¯¦è§£</h2>
            <h3>åˆ›å»ºHandler</h3>
            <pre><code><span class="comment">// æ–¹å¼1: åœ¨ä¸»çº¿ç¨‹ç›´æ¥åˆ›å»ºï¼ˆå…³è”ä¸»çº¿ç¨‹Looperï¼‰</span>
<span class="keyword">val</span> handler = <span class="type">Handler</span>(<span class="type">Looper</span>.getMainLooper()) { msg ->
    <span class="comment">// å¤„ç†æ¶ˆæ¯</span>
    <span class="keyword">true</span>
}

<span class="comment">// æ–¹å¼2: ä½¿ç”¨Handleræ„é€ å‡½æ•°ï¼ˆå·²åºŸå¼ƒï¼Œä½†ä»å¸¸è§ï¼‰</span>
<span class="keyword">val</span> handler = <span class="keyword">object</span> : <span class="type">Handler</span>() {
    <span class="keyword">override fun</span> handleMessage(msg: <span class="type">Message</span>) {
        <span class="keyword">when</span> (msg.what) {
            <span class="string">1</span> -> <span class="comment">// å¤„ç†æ¶ˆæ¯ç±»å‹1</span>
            <span class="string">2</span> -> <span class="comment">// å¤„ç†æ¶ˆæ¯ç±»å‹2</span>
        }
    }
}

<span class="comment">// æ–¹å¼3: æ¨è - æŒ‡å®šLooperé¿å…å†…å­˜æ³„æ¼è­¦å‘Š</span>
<span class="keyword">val</span> handler = <span class="type">Handler</span>(<span class="type">Looper</span>.getMainLooper())</code></pre>

            <h3>å‘é€æ¶ˆæ¯çš„æ–¹å¼</h3>
            <table>
                <thead>
                    <tr>
                        <th>æ–¹æ³•</th>
                        <th>è¯´æ˜</th>
                        <th>ä½¿ç”¨åœºæ™¯</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>sendMessage(msg)</code></td>
                        <td>å‘é€Messageå¯¹è±¡</td>
                        <td>ä¼ é€’å¤æ‚æ•°æ®</td>
                    </tr>
                    <tr>
                        <td><code>sendEmptyMessage(what)</code></td>
                        <td>å‘é€ç©ºæ¶ˆæ¯</td>
                        <td>ä»…éœ€æ ‡è¯†ï¼Œæ— æ•°æ®</td>
                    </tr>
                    <tr>
                        <td><code>sendMessageDelayed(msg, delay)</code></td>
                        <td>å»¶è¿Ÿå‘é€</td>
                        <td>å®šæ—¶ä»»åŠ¡</td>
                    </tr>
                    <tr>
                        <td><code>sendMessageAtTime(msg, time)</code></td>
                        <td>æŒ‡å®šæ—¶é—´å‘é€</td>
                        <td>ç²¾ç¡®å®šæ—¶</td>
                    </tr>
                    <tr>
                        <td><code>post(runnable)</code></td>
                        <td>å‘é€Runnable</td>
                        <td>ç®€å•ä»»åŠ¡</td>
                    </tr>
                    <tr>
                        <td><code>postDelayed(runnable, delay)</code></td>
                        <td>å»¶è¿Ÿæ‰§è¡ŒRunnable</td>
                        <td>å»¶è¿ŸUIæ“ä½œ</td>
                    </tr>
                </tbody>
            </table>

            <pre><code><span class="comment">// å‘é€Message</span>
<span class="keyword">val</span> msg = <span class="type">Message</span>.obtain().apply {
    what = <span class="string">1</span>
    arg1 = <span class="string">100</span>
    obj = <span class="string">"Hello"</span>
}
handler.sendMessage(msg)

<span class="comment">// å‘é€å»¶è¿Ÿæ¶ˆæ¯</span>
handler.sendEmptyMessageDelayed(<span class="string">1</span>, <span class="string">1000</span>) <span class="comment">// 1ç§’å</span>

<span class="comment">// post Runnable</span>
handler.post {
    textView.text = <span class="string">"æ›´æ–°UI"</span>
}

<span class="comment">// å»¶è¿Ÿæ‰§è¡Œ</span>
handler.postDelayed({
    showToast(<span class="string">"å»¶è¿Ÿæ˜¾ç¤º"</span>)
}, <span class="string">2000</span>)</code></pre>
        </section>

        <section id="looper" class="section">
            <h2>Looper è¯¦è§£</h2>
            <p>Looperè´Ÿè´£ä¸æ–­å¾ªç¯ä»MessageQueueä¸­å–å‡ºæ¶ˆæ¯ï¼Œå¹¶åˆ†å‘ç»™å¯¹åº”çš„Handlerå¤„ç†ã€‚æ¯ä¸ªçº¿ç¨‹æœ€å¤šåªèƒ½æœ‰ä¸€ä¸ªLooperã€‚</p>

            <h3>æ ¸å¿ƒAPI</h3>
            <table>
                <thead>
                    <tr>
                        <th>æ–¹æ³•</th>
                        <th>è¯´æ˜</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>Looper.prepare()</code></td>
                        <td>ä¸ºå½“å‰çº¿ç¨‹åˆ›å»ºLooper</td>
                    </tr>
                    <tr>
                        <td><code>Looper.loop()</code></td>
                        <td>å¼€å§‹æ¶ˆæ¯å¾ªç¯ï¼ˆé˜»å¡ï¼‰</td>
                    </tr>
                    <tr>
                        <td><code>Looper.myLooper()</code></td>
                        <td>è·å–å½“å‰çº¿ç¨‹çš„Looper</td>
                    </tr>
                    <tr>
                        <td><code>Looper.getMainLooper()</code></td>
                        <td>è·å–ä¸»çº¿ç¨‹Looper</td>
                    </tr>
                    <tr>
                        <td><code>looper.quit()</code></td>
                        <td>é€€å‡ºå¾ªç¯ï¼ˆä¸å®‰å…¨ï¼‰</td>
                    </tr>
                    <tr>
                        <td><code>looper.quitSafely()</code></td>
                        <td>å®‰å…¨é€€å‡ºï¼ˆå¤„ç†å®Œå·²æœ‰æ¶ˆæ¯ï¼‰</td>
                    </tr>
                </tbody>
            </table>

            <h3>åœ¨å­çº¿ç¨‹ä½¿ç”¨Looper</h3>
            <pre><code><span class="comment">// æ‰‹åŠ¨åˆ›å»ºå¸¦Looperçš„çº¿ç¨‹</span>
<span class="type">Thread</span> {
    <span class="type">Looper</span>.prepare()  <span class="comment">// 1. åˆ›å»ºLooper</span>
    
    <span class="keyword">val</span> handler = <span class="type">Handler</span>(<span class="type">Looper</span>.myLooper()!!) { msg ->
        <span class="comment">// åœ¨æ­¤çº¿ç¨‹å¤„ç†æ¶ˆæ¯</span>
        <span class="keyword">true</span>
    }
    
    <span class="type">Looper</span>.loop()  <span class="comment">// 2. å¼€å§‹å¾ªç¯ï¼ˆé˜»å¡åœ¨æ­¤ï¼‰</span>
}.start()

<span class="comment">// æ¨è: ä½¿ç”¨ HandlerThread</span>
<span class="keyword">val</span> handlerThread = <span class="type">HandlerThread</span>(<span class="string">"MyThread"</span>)
handlerThread.start()
<span class="keyword">val</span> handler = <span class="type">Handler</span>(handlerThread.looper)</code></pre>

            <div class="tip warn"><strong>âš ï¸
                    æ³¨æ„</strong>ä¸»çº¿ç¨‹çš„Looperç”±ç³»ç»Ÿåœ¨ActivityThread.main()ä¸­è‡ªåŠ¨åˆ›å»ºï¼Œæ— éœ€æ‰‹åŠ¨è°ƒç”¨prepare()ã€‚å­çº¿ç¨‹å¿…é¡»å…ˆè°ƒç”¨prepare()å†è°ƒç”¨loop()ã€‚
            </div>
        </section>

        <section id="queue" class="section">
            <h2>MessageQueue è¯¦è§£</h2>
            <p>MessageQueueæ˜¯ä¸€ä¸ªæŒ‰æ¶ˆæ¯æ‰§è¡Œæ—¶é—´æ’åºçš„å•é“¾è¡¨ç»“æ„ï¼Œå†…éƒ¨é€šè¿‡nativeæ–¹æ³•å®ç°é˜»å¡/å”¤é†’æœºåˆ¶ã€‚</p>

            <div class="cards">
                <div class="card">
                    <h3>ğŸ“¥ enqueueMessage</h3>
                    <p>æ’å…¥æ¶ˆæ¯åˆ°é˜Ÿåˆ—ï¼ŒæŒ‰whenæ—¶é—´æ’åºï¼Œæ’å…¥åå”¤é†’é˜»å¡çš„next()æ–¹æ³•</p>
                </div>
                <div class="card">
                    <h3>ğŸ“¤ next()</h3>
                    <p>å–å‡ºä¸‹ä¸€æ¡æ¶ˆæ¯ï¼Œå¦‚æœæ²¡æœ‰æ¶ˆæ¯ä¼šé˜»å¡ï¼ˆé€šè¿‡nativeçš„epollæœºåˆ¶ï¼‰</p>
                </div>
                <div class="card">
                    <h3>ğŸš« removeMessages</h3>
                    <p>ç§»é™¤æŒ‡å®šwhatæˆ–Runnableçš„æ¶ˆæ¯ï¼Œç”¨äºå–æ¶ˆå¾…æ‰§è¡Œä»»åŠ¡</p>
                </div>
                <div class="card">
                    <h3>ğŸ”Œ IdleHandler</h3>
                    <p>æ¶ˆæ¯é˜Ÿåˆ—ç©ºé—²æ—¶çš„å›è°ƒï¼Œé€‚åˆæ‰§è¡Œä½ä¼˜å…ˆçº§ä»»åŠ¡</p>
                </div>
            </div>

            <h3>IdleHandler ä½¿ç”¨</h3>
            <pre><code><span class="comment">// æ·»åŠ  IdleHandler - åœ¨æ¶ˆæ¯é˜Ÿåˆ—ç©ºé—²æ—¶æ‰§è¡Œ</span>
<span class="type">Looper</span>.myQueue().addIdleHandler {
    <span class="comment">// æ‰§è¡Œç©ºé—²ä»»åŠ¡ï¼Œå¦‚ï¼šé¢„åŠ è½½ã€ç»Ÿè®¡ä¸ŠæŠ¥ç­‰</span>
    doIdleWork()
    <span class="keyword">false</span>  <span class="comment">// false=æ‰§è¡Œä¸€æ¬¡åç§»é™¤, true=ä¿æŒ</span>
}</code></pre>
        </section>

        <section id="message" class="section">
            <h2>Message è¯¦è§£</h2>
            <h3>Message å±æ€§</h3>
            <table>
                <thead>
                    <tr>
                        <th>å±æ€§</th>
                        <th>ç±»å‹</th>
                        <th>è¯´æ˜</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>what</code></td>
                        <td>int</td>
                        <td>æ¶ˆæ¯æ ‡è¯†ç </td>
                    </tr>
                    <tr>
                        <td><code>arg1, arg2</code></td>
                        <td>int</td>
                        <td>ç®€å•æ•´æ•°å‚æ•°</td>
                    </tr>
                    <tr>
                        <td><code>obj</code></td>
                        <td>Object</td>
                        <td>ä»»æ„å¯¹è±¡æ•°æ®</td>
                    </tr>
                    <tr>
                        <td><code>data</code></td>
                        <td>Bundle</td>
                        <td>å¤æ‚æ•°æ®å®¹å™¨</td>
                    </tr>
                    <tr>
                        <td><code>target</code></td>
                        <td>Handler</td>
                        <td>ç›®æ ‡Handler</td>
                    </tr>
                    <tr>
                        <td><code>when</code></td>
                        <td>long</td>
                        <td>æ‰§è¡Œæ—¶é—´</td>
                    </tr>
                    <tr>
                        <td><code>callback</code></td>
                        <td>Runnable</td>
                        <td>postçš„Runnable</td>
                    </tr>
                </tbody>
            </table>

            <h3>åˆ›å»ºMessageï¼ˆæ¨èä½¿ç”¨obtainå¤ç”¨ï¼‰</h3>
            <pre><code><span class="comment">// âœ… æ¨è: ä»å¯¹è±¡æ± è·å–ï¼Œé¿å…é¢‘ç¹åˆ›å»º</span>
<span class="keyword">val</span> msg = <span class="type">Message</span>.obtain()
<span class="keyword">val</span> msg = <span class="type">Message</span>.obtain(handler, what, arg1, arg2, obj)
<span class="keyword">val</span> msg = handler.obtainMessage(what)

<span class="comment">// âŒ ä¸æ¨è: ç›´æ¥new</span>
<span class="keyword">val</span> msg = <span class="type">Message</span>()  <span class="comment">// æµªè´¹å†…å­˜</span></code></pre>

            <div class="tip success"><strong>ğŸ’¡
                    Messageå¯¹è±¡æ± </strong>Messageå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªå¤§å°ä¸º50çš„å¯¹è±¡æ± ï¼ˆå•é“¾è¡¨ï¼‰ï¼Œé€šè¿‡obtain()è·å–å¤ç”¨å¯¹è±¡ï¼Œrecycle()å›æ”¶ã€‚ç³»ç»Ÿä¼šè‡ªåŠ¨å›æ”¶å¤„ç†å®Œçš„Messageã€‚
            </div>
        </section>

        <section id="flow" class="section">
            <h2>æ¶ˆæ¯å¤„ç†æµç¨‹</h2>
            <h3>dispatchMessage å¤„ç†é¡ºåº</h3>
            <pre><code><span class="keyword">public void</span> dispatchMessage(<span class="type">Message</span> msg) {
    <span class="comment">// 1. ä¼˜å…ˆæ‰§è¡Œ Message.callback (postçš„Runnable)</span>
    <span class="keyword">if</span> (msg.callback != <span class="keyword">null</span>) {
        handleCallback(msg);
    } <span class="keyword">else</span> {
        <span class="comment">// 2. å…¶æ¬¡æ‰§è¡Œ Handler.mCallback</span>
        <span class="keyword">if</span> (mCallback != <span class="keyword">null</span>) {
            <span class="keyword">if</span> (mCallback.handleMessage(msg)) {
                <span class="keyword">return</span>;
            }
        }
        <span class="comment">// 3. æœ€åæ‰§è¡Œ handleMessage()</span>
        handleMessage(msg);
    }
}</code></pre>

            <div class="flow">
                <div class="flow-title">æ¶ˆæ¯å¤„ç†ä¼˜å…ˆçº§</div>
                <div class="flow-steps">
                    <div class="flow-step">1ï¸âƒ£ Message.callback</div>
                    <span class="flow-arrow">â†’</span>
                    <div class="flow-step">2ï¸âƒ£ Handler.Callback</div>
                    <span class="flow-arrow">â†’</span>
                    <div class="flow-step">3ï¸âƒ£ handleMessage()</div>
                </div>
            </div>
        </section>

        <section id="thread" class="section">
            <h2>çº¿ç¨‹é—´é€šä¿¡</h2>
            <h3>å­çº¿ç¨‹æ›´æ–°UI</h3>
            <pre><code><span class="comment">// æ–¹å¼1: ä¸»çº¿ç¨‹Handler</span>
<span class="keyword">val</span> mainHandler = <span class="type">Handler</span>(<span class="type">Looper</span>.getMainLooper())
<span class="type">Thread</span> {
    <span class="keyword">val</span> result = doBackground()
    mainHandler.post {
        textView.text = result  <span class="comment">// æ›´æ–°UI</span>
    }
}.start()

<span class="comment">// æ–¹å¼2: Activity.runOnUiThread()</span>
<span class="type">Thread</span> {
    <span class="keyword">val</span> result = doBackground()
    runOnUiThread {
        textView.text = result
    }
}.start()

<span class="comment">// æ–¹å¼3: View.post()</span>
<span class="type">Thread</span> {
    <span class="keyword">val</span> result = doBackground()
    textView.post {
        textView.text = result
    }
}.start()</code></pre>

            <h3>HandlerThread ä½¿ç”¨</h3>
            <pre><code><span class="comment">// åˆ›å»ºå¸¦Looperçš„åå°çº¿ç¨‹</span>
<span class="keyword">class</span> <span class="type">MyService</span> : <span class="type">Service</span>() {
    <span class="keyword">private lateinit var</span> handlerThread: <span class="type">HandlerThread</span>
    <span class="keyword">private lateinit var</span> serviceHandler: <span class="type">Handler</span>

    <span class="keyword">override fun</span> onCreate() {
        handlerThread = <span class="type">HandlerThread</span>(<span class="string">"ServiceThread"</span>)
        handlerThread.start()
        serviceHandler = <span class="type">Handler</span>(handlerThread.looper) { msg ->
            <span class="comment">// åœ¨åå°çº¿ç¨‹å¤„ç†ä»»åŠ¡</span>
            <span class="keyword">true</span>
        }
    }

    <span class="keyword">override fun</span> onDestroy() {
        handlerThread.quitSafely()  <span class="comment">// å®‰å…¨é€€å‡º</span>
    }
}</code></pre>
        </section>

        <section id="practice" class="section">
            <h2>æœ€ä½³å®è·µ</h2>
            <div class="cards">
                <div class="card">
                    <h3>ğŸš« é¿å…å†…å­˜æ³„æ¼</h3>
                    <p>ä½¿ç”¨é™æ€å†…éƒ¨ç±»+WeakReferenceï¼Œæˆ–åœ¨onDestroyä¸­è°ƒç”¨removeCallbacksAndMessages(null)</p>
                </div>
                <div class="card">
                    <h3>â™»ï¸ Messageå¤ç”¨</h3>
                    <p>å§‹ç»ˆä½¿ç”¨Message.obtain()æˆ–handler.obtainMessage()è·å–Messageå¯¹è±¡</p>
                </div>
                <div class="card">
                    <h3>ğŸ›¡ï¸ æŒ‡å®šLooper</h3>
                    <p>åˆ›å»ºHandleræ—¶æ˜ç¡®æŒ‡å®šLooperï¼Œé¿å…éšå¼ä½¿ç”¨å½“å‰çº¿ç¨‹Looper</p>
                </div>
                <div class="card">
                    <h3>ğŸ”š åŠæ—¶é€€å‡º</h3>
                    <p>å­çº¿ç¨‹Looperä½¿ç”¨å®Œæ¯•åè°ƒç”¨quitSafely()é‡Šæ”¾èµ„æº</p>
                </div>
            </div>

            <h3>é¿å…å†…å­˜æ³„æ¼çš„æ­£ç¡®å†™æ³•</h3>
            <pre><code><span class="keyword">class</span> <span class="type">MyActivity</span> : <span class="type">AppCompatActivity</span>() {
    
    <span class="comment">// é™æ€å†…éƒ¨ç±» + WeakReference</span>
    <span class="keyword">private class</span> <span class="type">MyHandler</span>(activity: <span class="type">MyActivity</span>) : <span class="type">Handler</span>(<span class="type">Looper</span>.getMainLooper()) {
        <span class="keyword">private val</span> weakActivity = <span class="type">WeakReference</span>(activity)
        
        <span class="keyword">override fun</span> handleMessage(msg: <span class="type">Message</span>) {
            weakActivity.get()?.handleMsg(msg)
        }
    }
    
    <span class="keyword">private val</span> handler = <span class="type">MyHandler</span>(<span class="keyword">this</span>)
    
    <span class="keyword">override fun</span> onDestroy() {
        <span class="keyword">super</span>.onDestroy()
        handler.removeCallbacksAndMessages(<span class="keyword">null</span>)  <span class="comment">// æ¸…é™¤æ‰€æœ‰æ¶ˆæ¯</span>
    }
}</code></pre>
        </section>
    </div>
    <script>document.querySelectorAll('.toc a').forEach(a => a.addEventListener('click', e => { e.preventDefault(); document.querySelector(a.getAttribute('href')).scrollIntoView({ behavior: 'smooth' }) }))</script>
</body>

</html>